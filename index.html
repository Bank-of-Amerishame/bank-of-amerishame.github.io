<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bank of Amerishame - Currency Converter & Accounts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
        header { background: #16417c; color: #fff; padding: 2rem 1rem; text-align: center; }
        main { max-width: 500px; background: #fff; margin: 2rem auto; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 2rem; }
        .converter-form, .loan-form, .auth-form { display: flex; flex-direction: column; gap: 1.5rem; }
        select, input[type="number"], input[type="text"], input[type="date"], input[type="password"] { padding: 0.5rem; font-size: 1rem; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #16417c; color: #fff; border: none; padding: 0.75rem; font-size: 1rem; border-radius: 5px; cursor: pointer; }
        .result { margin-top: 1.5rem; font-size: 1.2rem; font-weight: bold; text-align: center; }
        .rates { margin-top: 2rem; font-size: 0.95rem; color: #333; }
        .loan-section { margin-top: 3rem; }
        .hidden { display: none; }
        .balance { margin: 1rem 0; font-size: 1.2rem; text-align: center; color: #16417c; }
        .user-bar { text-align: right; margin-bottom: 1rem; }
        .user-bar span { margin-right: 1rem; }
        .warn { color: #c00; }
        .err { color: #c00; margin-bottom: 1rem; }
        footer { text-align: center; padding: 1rem 0; color: #888; }
    </style>
</head>
<body>
    <header>
        <h1>Bank of Amerishame</h1>
        <p>Your trusted currency converter</p>
    </header>
    <main>
        <div class="user-bar" id="userBar">
            <!-- Populated by JS: login/signup/logout -->
        </div>
        <div class="balance" id="balanceBar"></div>
        
        <form class="auth-form" id="authForm" onsubmit="return handleAuth(event)">
            <div class="err" id="authErr"></div>
            <label>
                Username:
                <input type="text" id="authUsername" required autocomplete="username">
            </label>
            <label>
                Password:
                <input type="password" id="authPassword" required autocomplete="current-password">
            </label>
            <button type="submit" id="authBtn">Login / Sign Up</button>
        </form>
        
        <form class="converter-form hidden" id="converterForm" onsubmit="return convertCurrency(event)">
            <label>
                Amount:
                <input type="number" id="amount" min="0" step="any" required>
            </label>
            <label>
                From:
                <select id="fromCurrency">
                    <option value="ruevel">Ruevel</option>
                    <option value="pea">Pea</option>
                    <option value="zyatt">Zyatt</option>
                    <option value="token">Token</option>
                </select>
            </label>
            <label>
                To:
                <select id="toCurrency">
                    <option value="ruevel">Ruevel</option>
                    <option value="pea">Pea</option>
                    <option value="zyatt">Zyatt</option>
                    <option value="token">Token</option>
                </select>
            </label>
            <button type="submit">Convert</button>
        </form>
        <div class="result" id="result"></div>
        <div class="rates">
            <strong>Exchange Rates:</strong>
            <ul>
                <li>500 Ruevels = 1 Zyatt</li>
                <li>200 Zyatts = 1 Token</li>
                <li>20 Peas = 1 Zyatt</li>
                <li>25 Ruevels = 1 Pea</li>
            </ul>
        </div>

        <div class="loan-section">
            <button id="makeLoanBtn" onclick="showLoanForm()" type="button" class="hidden">Make a Loan</button>
            <form class="loan-form hidden" id="loanForm" onsubmit="return submitLoan(event)">
                <label>
                    Your Name:
                    <input type="text" id="loanName" required>
                </label>
                <label>
                    Age:
                    <input type="number" id="loanAge" required min="1" max="130">
                </label>
                <label>
                    Date:
                    <input type="date" id="loanDate" required>
                </label>
                <label>
                    Amount Wanted (in Tokens):
                    <input type="number" id="loanAmountTokens" step="any" min="0.01" required>
                </label>
                <label>
                    Currency to Give in Return:
                    <select id="loanCurrency" onchange="updateLoanEquivalent()">
                        <option value="ruevel">Ruevel</option>
                        <option value="pea">Pea</option>
                        <option value="zyatt">Zyatt</option>
                        <option value="token">Token</option>
                    </select>
                </label>
                <div id="loanEquivalent"></div>
                <button type="submit">Submit Loan Request</button>
                <button type="button" onclick="hideLoanForm()">Cancel</button>
            </form>
        </div>
    </main>
    <footer>
        &copy; 2025 Bank of Amerishame. All rights reserved.
    </footer>
    <script>
        // Currency rates
        const rates = {
            ruevel: {
                toZyatt: v => v / 500,
                toPea: v => v / 25,
                toToken: v => v / 500 / 200,
                fromZyatt: v => v * 500,
                fromPea: v => v * 25,
                fromToken: v => v * 200 * 500
            },
            pea: {
                toZyatt: v => v / 20,
                toRuevel: v => v * 25,
                toToken: v => v / 20 / 200,
                fromZyatt: v => v * 20,
                fromRuevel: v => v / 25,
                fromToken: v => v * 200 * 20
            },
            zyatt: {
                toRuevel: v => v * 500,
                toPea: v => v * 20,
                toToken: v => v / 200,
                fromRuevel: v => v / 500,
                fromPea: v => v / 20,
                fromToken: v => v * 200
            },
            token: {
                toZyatt: v => v * 200,
                toRuevel: v => v * 200 * 500,
                toPea: v => v * 200 * 20,
                fromZyatt: v => v / 200,
                fromRuevel: v => v / 200 / 500,
                fromPea: v => v / 200 / 20
            }
        };

        // Account logic
        const STORAGE_KEY = "amerishame_accounts";
        const SESSION_KEY = "amerishame_current_user";
        function getAccounts() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        }
        function setAccounts(obj) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
        }
        function getCurrentUser() {
            return localStorage.getItem(SESSION_KEY);
        }
        function setCurrentUser(username) {
            if (username) localStorage.setItem(SESSION_KEY, username);
            else localStorage.removeItem(SESSION_KEY);
        }

        function daysSince(dateStr) {
            return Math.floor((Date.now() - new Date(dateStr).getTime()) / (1000*60*60*24));
        }

        function updateUserBar() {
            const user = getCurrentUser();
            const bar = document.getElementById("userBar");
            if (user) {
                bar.innerHTML = `<span>Logged in as <strong>${user}</strong></span><button onclick="handleLogout()">Logout</button>`;
            } else {
                bar.innerHTML = "";
            }
        }

        function updateBalanceBar() {
            const user = getCurrentUser();
            const bar = document.getElementById("balanceBar");
            if (user) {
                const acc = getAccounts()[user];
                bar.textContent = `Balance: ${acc.zyatts.toLocaleString()} Zyatts`;
            } else {
                bar.textContent = "";
            }
        }

        function showAuthForm(show=true) {
            document.getElementById("authForm").classList.toggle("hidden", !show);
            document.getElementById("authErr").innerText = "";
        }
        function showBankFeatures(show=true) {
            document.getElementById("converterForm").classList.toggle("hidden", !show);
            document.getElementById("makeLoanBtn").classList.toggle("hidden", !show);
        }

        function handleAuth(event) {
            event.preventDefault();
            const username = document.getElementById("authUsername").value.trim();
            const password = document.getElementById("authPassword").value;
            const err = document.getElementById("authErr");
            err.innerText = "";
            if (!username || !password) {
                err.innerText = "Please provide both username and password.";
                return false;
            }
            let accounts = getAccounts();
            let acc = accounts[username];

            // If new account, create it with special zyatt balances if special users
            if (!acc) {
                let initialZyatts = 500;
                if (username.toLowerCase() === "meeper") initialZyatts = 1000;
                else if (username.toLowerCase() === "pinkhowl") initialZyatts = 9999999;
                else if (username.toLowerCase() === "bingandabong") initialZyatts = 9999999999999999999;
                acc = {
                    zyatts: initialZyatts,
                    lastReward: new Date().toISOString(),
                    password: password // store password in plain text for demo only!
                };
                accounts[username] = acc;
                setAccounts(accounts);
            } else {
                // Existing user: check password
                if (!acc.password) {
                    acc.password = password;
                    accounts[username] = acc;
                    setAccounts(accounts);
                } else if (acc.password !== password) {
                    err.innerText = "Incorrect password for this username.";
                    return false;
                }
                // Existing user: apply periodic reward
                applyPeriodicReward(username, acc);
            }
            setCurrentUser(username);
            updateUserBar();
            updateBalanceBar();
            showAuthForm(false);
            showBankFeatures(true);
            document.getElementById("converterForm").reset();
            hideLoanForm();
            return false;
        }

        function handleLogout() {
            setCurrentUser(null);
            showAuthForm(true);
            showBankFeatures(false);
            updateUserBar();
            updateBalanceBar();
            hideLoanForm();
        }

        function applyPeriodicReward(username, acc) {
            const now = new Date();
            const last = new Date(acc.lastReward);
            const msPer3Days = 3*24*60*60*1000;
            let elapsed = now.getTime() - last.getTime();
            let increments = Math.floor(elapsed / msPer3Days);
            if (increments > 0) {
                acc.zyatts += 50 * increments;
                acc.lastReward = new Date(last.getTime() + increments * msPer3Days).toISOString();
                let accounts = getAccounts();
                accounts[username] = acc;
                setAccounts(accounts);
            }
        }

        // Currency converter
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function convertCurrency(event) {
            event.preventDefault();
            const amount = parseFloat(document.getElementById('amount').value);
            const from = document.getElementById('fromCurrency').value;
            const to = document.getElementById('toCurrency').value;
            let result = 0;

            if (from === to) {
                result = amount;
            } else if (typeof rates[from][`to${capitalize(to)}`] === 'function') {
                result = rates[from][`to${capitalize(to)}`](amount);
            } else if (typeof rates[to][`from${capitalize(from)}`] === 'function') {
                result = rates[to][`from${capitalize(from)}`](amount);
            } else {
                // Indirect conversion via Zyatt
                const toZyatt = (typeof rates[from].toZyatt === 'function') ? rates[from].toZyatt(amount) : null;
                if (toZyatt !== null && typeof rates[to].fromZyatt === 'function') {
                    result = rates[to].fromZyatt(toZyatt);
                } else {
                    document.getElementById('result').innerText = 'Conversion not supported.';
                    return false;
                }
            }
            document.getElementById('result').innerText = `${amount} ${capitalize(from)} = ${result.toLocaleString(undefined, {maximumFractionDigits: 8})} ${capitalize(to)}`;
            return false;
        }

        // LOAN FORM LOGIC
        function showLoanForm() {
            document.getElementById('loanForm').classList.remove('hidden');
            updateLoanEquivalent();
        }

        function hideLoanForm() {
            document.getElementById('loanForm').reset();
            document.getElementById('loanEquivalent').innerText = '';
            document.getElementById('loanForm').classList.add('hidden');
        }

        function updateLoanEquivalent() {
            const tokens = parseFloat(document.getElementById('loanAmountTokens').value) || 0;
            const giveCurrency = document.getElementById('loanCurrency').value;
            let equivalent = 0;
            if (tokens > 0) {
                switch (giveCurrency) {
                    case 'token':
                        equivalent = tokens;
                        break;
                    case 'zyatt':
                        equivalent = tokens * 200;
                        break;
                    case 'pea':
                        equivalent = tokens * 200 * 20;
                        break;
                    case 'ruevel':
                        equivalent = tokens * 200 * 500;
                        break;
                }
            }
            document.getElementById('loanEquivalent').innerText = tokens
                ? `You should give ${equivalent.toLocaleString()} ${capitalize(giveCurrency)} in return.`
                : '';
        }

        document.getElementById('loanAmountTokens').addEventListener('input', updateLoanEquivalent);
        document.getElementById('loanCurrency').addEventListener('change', updateLoanEquivalent);

        // ---- Mail sending helper using mailto for download ----
        function sendMailAuto({to, subject, body}) {
            // Create a mailto link and simulate a click
            // This will still open the user's email client, as fully silent sending is not possible on the web for privacy reasons.
            // For best "auto" effect, create and click a temporary anchor.
            const mailtoLink = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            const a = document.createElement('a');
            a.href = mailtoLink;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => document.body.removeChild(a), 100);
        }

        function submitLoan(event) {
            event.preventDefault();

            const name = document.getElementById('loanName').value.trim();
            const age = document.getElementById('loanAge').value.trim();
            const date = document.getElementById('loanDate').value;
            const tokens = parseFloat(document.getElementById('loanAmountTokens').value);
            const giveCurrency = document.getElementById('loanCurrency').value;
            let equivalent = 0;
            switch (giveCurrency) {
                case 'token':
                    equivalent = tokens;
                    break;
                case 'zyatt':
                    equivalent = tokens * 200;
                    break;
                case 'pea':
                    equivalent = tokens * 200 * 20;
                    break;
                case 'ruevel':
                    equivalent = tokens * 200 * 500;
                    break;
            }

            const user = getCurrentUser();
            if (!user) return false;
            const accs = getAccounts();
            const acc = accs[user];
            // No zyatt check

            // Tax always 2 tokens
            const tax = 2;
            const subject = "loan";
            const body =
                `Name: ${name}\nAge: ${age}\nDate: ${date}\n` +
                `Amount wanted (Tokens): ${tokens}\n` +
                `Currency to give in return: ${capitalize(giveCurrency)}\n` +
                `Equivalent amount to give: ${equivalent}\n` +
                `Tax (in Tokens): ${tax}\n` +
                `Username: ${user}\n` +
                `Account Balance (Zyatts): ${acc.zyatts}`;
            // Send mail automatically (as much as the browser allows)
            sendMailAuto({to: "s178697@scusd.net", subject, body});
            hideLoanForm();
            return false;
        }

        // On load, show login or main features
        function setupOnLoad() {
            const user = getCurrentUser();
            updateUserBar();
            updateBalanceBar();
            if (user) {
                // Existing user: apply reward
                let accs = getAccounts();
                applyPeriodicReward(user, accs[user]);
                updateBalanceBar();
                showAuthForm(false);
                showBankFeatures(true);
            } else {
                showAuthForm(true);
                showBankFeatures(false);
            }
        }
        window.onload = setupOnLoad;
    </script>
</body>
</html>
